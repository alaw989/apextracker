---
phase: 04-performance
plan: 03
type: execute
wave: 2
depends_on: [04-01, 04-02]
files_modified:
  - vite.config.js
  - package.json
autonomous: true

must_haves:
  truths:
    - "Production build generates minified JavaScript and CSS"
    - "Build completes with esbuild minifier (20-40x faster than terser)"
    - "Bundle size warning limit enforced (150KB per chunk)"
    - "Vendor code split from app code (manualChunks configured)"
    - "Build output shows chunk sizes for analysis"
  artifacts:
    - path: "vite.config.js"
      provides: "Build configuration with optimization"
      contains: "build.rollupOptions"
    - path: "package.json"
      provides: "Build scripts and optional dev dependencies"
      exports: ["build", "analyze"]
    - path: "dist/assets/"
      provides: "Minified production bundles"
      min_lines: 2
  key_links:
    - from: "vite.config.js"
      to: "Vite build system"
      via: "build.rollupOptions.manualChunks"
      pattern: "manualChunks.*function"
    - from: "package.json"
      to: "vite-plugin-compression (optional)"
      via: "devDependencies"
      pattern: "vite-plugin-compression|rollup-plugin-visualizer"
---

<objective>
Configure Vite build optimizations to minimize bundle size, enable code splitting, and set up bundle analysis tools.

Purpose: Minimize time to interactive by reducing initial bundle size through code splitting (vendor vs app code), set bundle size budgets to prevent bloat, and enable optional compression plugins for production deployment.

Output: Optimized vite.config.js with manualChunks, chunkSizeWarningLimit, optional compression plugins, and bundle analysis script.
</objective>

<execution_context>
@/home/deck/.claude/get-shit-done/workflows/execute-plan.md
@/home/deck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-performance/04-CONTEXT.md
@.planning/phases/04-performance/04-RESEARCH.md

# Locked Decisions from CONTEXT.md
- Primary metric: Load time — Minimize time to interactive above all else
- Set bundle size budgets — Enforce limits to prevent bloat
- Minimize dependencies — Aggressively tree-shake, avoid large libraries
- Use code splitting — Route-based chunks for faster initial load

# Claude's Discretion
- Exact bundle budget numbers — Set reasonable limits based on typical Vue app sizes (RESEARCH recommends: warning 150KB, error 200KB)
- Use esbuild minifier (Vite default) — 20-40x faster than terser with only 1-2% worse compression

@vite.config.js
@package.json
@src/main.js
@src/router/index.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure Vite build optimization settings</name>
  <files>vite.config.js</files>
  <action>
Modify `vite.config.js` to add build optimization configuration:

1. **Add build configuration object:**
   ```javascript
   export default defineConfig({
     // ... existing plugins, resolve, server config ...

     build: {
       // Set chunk size warning limit to 150KB (per RESEARCH.md recommendation)
       chunkSizeWarningLimit: 150,

       // Use esbuild minifier (Vite default, 20-40x faster than terser)
       minify: 'esbuild',

       // Target modern browsers for smaller output
       target: 'es2015',

       rollupOptions: {
         output: {
           // Manual code splitting for better caching
           manualChunks(id) {
             // Split vendor code from app code
             if (id.includes('node_modules')) {
               // Separate Vue core (vue, pinia, vue-router) for stable long-term cache
               if (id.includes('vue') || id.includes('pinia') || id.includes('@vue')) {
                 return 'vue-vendor'
               }
               // Separate VueUse (frequently updated)
               if (id.includes('@vueuse')) {
                 return 'vueuse'
               }
               // Other vendor code
               return 'vendor'
             }
           }
         }
       }
     }
   })
   ```

2. **Keep existing configuration:**
   - plugins: [vue()]
   - resolve.alias: { '@': ... }
   - server.proxy: { ... }

3. **Add comments explaining:**
   - Why 150KB limit (appropriate for Vue apps per web.dev)
   - Why esbuild over terser (20-40x faster builds)
   - Why manualChunks separation (browser caching strategy)

Do NOT add compression plugins yet — that's Task 2 (optional).
  </action>
  <verify>
Run `npm run build` and verify:
1. Build completes without errors
2. Output shows chunk sizes in terminal
3. dist/assets/ contains vue-vendor-*.js, vueuse-*.js, vendor-*.js, index-*.js
4. No chunk size warnings (or only intentional ones if exceeding 150KB)
  </verify>
  <done>
vite.config.js has build config with chunkSizeWarningLimit: 150, minify: 'esbuild', manualChunks for vue-vendor, vueuse, and vendor separation. Build completes successfully.
</done>
</task>

<task type="auto">
  <name>Task 2: Add optional compression and bundle analysis tools</name>
  <files>package.json</files>
  <action>
**Part A: Add optional dev dependencies**

Add to package.json devDependencies (ONLY if user wants them — these are OPTIONAL):

1. `vite-plugin-compression` — Generates .gz and .br files during build for serving compressed assets
2. `rollup-plugin-visualizer` — Generates bundle analysis visualization

**Part B: Add npm scripts**

Modify package.json scripts section:
```json
"scripts": {
  "dev": "vite",
  "build": "vite build",
  "preview": "vite preview",
  "build:analyze": "vite build --mode analyze"
}
```

**Part C: Create vite.config.js condition for analyze mode**

Add to vite.config.js (after build config):
```javascript
// Conditional plugins for bundle analysis
import { visualizer } from 'rollup-plugin-visualizer'

const plugins = [vue()]

// Add visualizer plugin only in analyze mode
if (process.argv.includes('--mode') && process.argv.includes('analyze')) {
  plugins.push(
    visualizer({
      filename: 'dist/stats.html',
      gzipSize: true,
      brotliSize: true
    })
  )
}

export default defineConfig({
  plugins
  // ... rest of config
})
```

**Part D: Optional compression plugin setup**

If user wants gzip/brotli compression (add comment as OPTIONAL):
- Uncomment vite-plugin-compression import
- Add to plugins array
- Configure for gzip and brotli with compression level 9

**Important:** These tools are OPTIONAL. Only add if user confirms they want them.
- If not adding, create a comment block showing how to enable them later

Per Claude's discretion: Set up the structure for these tools but make them opt-in via comments or separate scripts. Don't force every build to generate stats.html.
  </action>
  <verify>
1. Run `npm run build` — should work without new dependencies
2. Run `npm run build:analyze` — should generate dist/stats.html
3. Open dist/stats.html in browser — shows bundle visualization
4. Verify chunks are properly separated (vue-vendor, vueuse, vendor)
  </verify>
  <done>
package.json has build:analyze script. vite.config.js has conditional visualizer plugin for analyze mode. Build works with and without analyze flag. dist/stats.html generates bundle visualization.
</done>
</task>

<task type="auto">
  <name>Task 3: Verify build output and measure performance improvements</name>
  <files></files>
  <action>
**No file creation — verification task.**

Run the following verification steps:

1. **Clean build:**
   ```bash
   rm -rf dist
   npm run build
   ```

2. **Check bundle sizes:**
   - List dist/assets/ files with sizes
   - Verify index-[hash].js is under 150KB (uncompressed)
   - Verify vendor chunks are reasonable sizes

3. **Check minification:**
   - Open dist/assets/index-[hash].js
   - Verify code is minified (no whitespace, single line)
   - Verify CSS in index-[hash].css is also minified

4. **Verify chunk separation:**
   - dist/assets/ should contain:
     - vue-vendor-[hash].js (Vue core)
     - vueuse-[hash].js (VueUse utilities)
     - vendor-[hash].js (other dependencies)
     - index-[hash].js (app code)

5. **Preview production build:**
   ```bash
   npm run preview
   ```
   - Visit http://localhost:4173
   - Test app functionality (search, display, share URLs)
   - Check DevTools Network tab — verify chunk loading

6. **Document results:**
   - Record bundle sizes (before/after if comparison available)
   - Note any chunk size warnings
   - Verify time to interactive < 2 seconds on typical connection

If issues found:
- Chunk size warnings: Consider further splitting or identify large dependencies
- Build errors: Fix configuration issues
- Functional issues: Test and debug

Create a summary of findings for the SUMMARY.md.
  </action>
  <verify>
1. Build completes without errors
2. dist/assets/ contains properly separated chunks
3. Main bundle (index-[hash].js) is under 150KB
4. Preview mode works and app functions correctly
5. Network tab shows chunks loading separately
  </verify>
  <done>
Production build generates minified bundles. Code splitting separates vue-vendor, vueuse, vendor, and app chunks. Main bundle under 150KB. Preview mode works correctly. App functionality verified in production build.
</done>
</task>

</tasks>

<verification>
1. **Build configuration:** vite.config.js has build.rollupOptions with manualChunks
2. **Chunk separation:** Build output shows separate vue-vendor, vueuse, vendor files
3. **Bundle size limits:** chunkSizeWarningLimit set to 150KB, no warnings in console
4. **Minification:** Output JS/CSS is minified (esbuild minifier)
5. **Code splitting:** Network tab shows chunks loading separately in preview mode
6. **Bundle analysis:** npm run build:analyze generates dist/stats.html visualization
7. **Performance:** Time to interactive under 2 seconds on typical connection (measure with DevTools Performance tab)
</verification>

<success_criteria>
- [ ] Build completes successfully with esbuild minification
- [ ] Vendor code split from app code (manualChunks working)
- [ ] Main bundle under 150KB warning limit
- [ ] dist/stats.html generates for bundle analysis
- [ ] Production preview mode works correctly
- [ ] App functionality verified in production build
- [ ] Time to interactive under 2 seconds (typical connection)
</success_criteria>

<output>
After completion, create `.planning/phases/04-performance/04-03-SUMMARY.md` with:
- Final bundle sizes (vue-vendor, vueuse, vendor, app)
- Build time measurements
- Compression ratios (if compression enabled)
- Bundle analysis findings (largest dependencies)
- Performance metrics (time to interactive)
- Any deviations from plan
- Phase 4 completion summary
</output>
