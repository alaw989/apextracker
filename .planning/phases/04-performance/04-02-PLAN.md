---
phase: 04-performance
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/composables/useLazyImage.js
  - src/components/ui/LazyImage.vue
  - src/components/stats/PlayerHeader.vue
  - src/components/legends/LegendCard.vue
autonomous: true

must_haves:
  truths:
    - "Images fade in smoothly when loaded (not instant appearance)"
    - "Gray placeholder shown while image is loading"
    - "Viewport images load immediately without IntersectionObserver delay"
    - "All images (avatars, rank icons, legend art) use same lazy-loading behavior"
    - "Failed images show fallback placeholder"
    - "Lazy-loaded images trigger before entering viewport (rootMargin)"
  artifacts:
    - path: "src/composables/useLazyImage.js"
      provides: "IntersectionObserver-based lazy loading"
      exports: ["useLazyImage"]
    - path: "src/components/ui/LazyImage.vue"
      provides: "Reusable lazy image component with fade-in"
      min_lines: 60
  key_links:
    - from: "src/components/ui/LazyImage.vue"
      to: "src/composables/useLazyImage.js"
      via: "useLazyImage composable import"
      pattern: "useLazyImage"
    - from: "src/components/stats/PlayerHeader.vue"
      to: "src/components/ui/LazyImage.vue"
      via: "component replacement of img tags"
      pattern: "LazyImage"
    - from: "src/components/legends/LegendCard.vue"
      to: "src/components/ui/LazyImage.vue"
      via: "component replacement of img tags"
      pattern: "LazyImage"
    - from: "src/composables/useLazyImage.js"
      to: "@vueuse/core"
      via: "useIntersectionObserver import"
      pattern: "useIntersectionObserver"
---

<objective>
Implement lazy loading for all images (avatars, rank icons, legend art) using IntersectionObserver with smooth fade-in animations and gray placeholder boxes.

Purpose: Improve initial page load time by deferring off-screen image loads. Images fade in smoothly when loaded, with consistent gray placeholders during loading. Viewport images load immediately without waiting for IntersectionObserver.

Output: A reusable LazyImage component with useLazyImage composable, applied to all images in the app.
</objective>

<execution_context>
@/home/deck/.claude/get-shit-done/workflows/execute-plan.md
@/home/deck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-performance/04-CONTEXT.md
@.planning/phases/04-performance/04-RESEARCH.md

# Locked Decisions from CONTEXT.md
- Fade-in animation — Images fade in smoothly when loaded (not instant)
- Solid color placeholder — Gray box while image is loading
- Match existing animation style — Consistent with current card transitions (0.4s cubic-bezier(0.16, 1, 0.3, 1))
- Viewport images load immediately — Images in initial viewport don't wait for IntersectionObserver
- All images use same behavior — Avatars, rank icons, legend art all consistent
- All images lazy load — Even small icons, though viewport images trigger immediately
- Failed image fallback — Use placeholder image if load fails

@src/style/transitions.css
@src/components/stats/PlayerHeader.vue
@src/components/legends/LegendCard.vue
@src/composables/usePageTitle.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useLazyImage composable with IntersectionObserver</name>
  <files>src/composables/useLazyImage.js</files>
  <action>
Create a new file `src/composables/useLazyImage.js` with the following:

1. **Imports:**
   - `ref`, `watch` from 'vue'
   - `useIntersectionObserver` from '@vueuse/core'

2. **Function `useLazyImage(src, options = {})`:**
   - **Parameters:**
     - `src` — Image URL string
     - `options` — Optional config object with `rootMargin` (default: '50px')

   - **State refs:**
     - `loaded` ref(false) — Image successfully loaded
     - `error` ref(false) — Image failed to load
     - `shouldLoad` ref(false) — Image should load now (visible in viewport)
     - `targetRef` ref(null) — DOM element ref for observer

   - **IntersectionObserver setup:**
     - Use `useIntersectionObserver(targetRef, callback, { rootMargin })`
     - Callback: If entry.isIntersecting, set shouldLoad = true and call stop()

   - **Viewport detection (immediate load for viewport images):**
     - Watch targetRef for changes
     - When element mounts, check getBoundingClientRect()
     - If rect.top < window.innerHeight AND rect.bottom > 0, set shouldLoad = true immediately
     - Call stop() to skip observer

   - **Error handling:**
     - No built-in error handling here — component will handle error state

   - **Return:** { loaded, error, shouldLoad, targetRef }

Per Claude's discretion on IntersectionObserver margin: Use 50px rootMargin (loads images slightly before entering viewport for smoother UX).
  </action>
  <verify>
Run `npm run dev` and test in browser console:
```javascript
import { useLazyImage } from '/src/composables/useLazyImage.js'
const { shouldLoad, targetRef } = useLazyImage('https://example.com/image.jpg')
// Mount targetRef element, observe shouldLoad becomes true when in viewport
```
  </verify>
  <done>
Composable exports useLazyImage. IntersectionObserver triggers shouldLoad when element enters viewport. Viewport images trigger immediately on mount. rootMargin of 50px loads images before visible.
</done>
</task>

<task type="auto">
  <name>Task 2: Create LazyImage component with fade-in animation</name>
  <files>src/components/ui/LazyImage.vue</files>
  <action>
Create a new file `src/components/ui/LazyImage.vue` with the following:

**Script section:**
1. Import `ref`, `computed` from 'vue'
2. Import `useLazyImage` from '@/composables/useLazyImage.js'
3. Props: `src` (String, required), `alt` (String), `placeholderColor` (String, default '#374151'), `class` (String)
4. Emit: `load`, `error` events
5. Use `useLazyImage(props.src)` composable
6. Handler functions: `onLoad()` sets loaded=true and emits, `onError()` sets error=true and emits

**Template section:**
1. Root div with `ref="targetRef"` and dynamic class binding
2. Conditional img element: `v-if="shouldLoad"`
   - Bind `:src="src"`, `:alt="alt"`
   - Class binding for loaded state (`lazy-image__loaded` when loaded=true)
   - `@load="onLoad"`, `@error="onError"`
3. Placeholder div: `v-if="!loaded && !error"`
   - Fixed style with `backgroundColor` from prop
   - Pulse animation (defined in styles)

**Style section:**
1. `.lazy-image` container: position relative, overflow hidden
2. `img` base styles: opacity 0, transition `opacity 0.4s cubic-bezier(0.16, 1, 0.3, 1)` (match transitions.css timing)
3. `.lazy-image__loaded`: opacity 1
4. `.lazy-image__placeholder`: absolute inset 0, pulse animation
5. `@keyframes pulse`: opacity 1 -> 0.5 -> 1 (1.5s ease-in-out infinite)
6. Support custom class via `:class="props.class"` on root div

**Accessibility:**
- If image fails and shows placeholder, add `role="img"` and `aria-label` from alt text
- If src is empty string, show placeholder immediately
  </action>
  <verify>
1. Use LazyImage in test component with valid image URL — should fade in when loaded
2. Use with invalid URL — should show placeholder
3. Check DevTools Network tab — image only loads when shouldLoad is true
4. Verify animation timing matches transitions.css (0.4s cubic-bezier)
  </verify>
  <done>
LazyImage component exists. Fade-in animation uses 0.4s cubic-bezier(0.16, 1, 0.3, 1) matching existing transitions. Gray placeholder shows during load. Failed images show placeholder with aria-label.
</done>
</task>

<task type="auto">
  <name>Task 3: Replace all img tags with LazyImage component</name>
  <files>src/components/stats/PlayerHeader.vue src/components/legends/LegendCard.vue</files>
  <action>
**Part A: Modify src/components/stats/PlayerHeader.vue**

1. Import LazyImage component
2. Replace avatar img element:
   - Remove: `<img v-if="avatarUrl && !avatarError" ... @error="handleAvatarError" />`
   - Add: `<LazyImage v-if="avatarUrl" :src="avatarUrl" :alt="\`\${playerName} avatar\`" class="player-header__avatar-img" @error="handleAvatarError" />`
   - Keep placeholder div as fallback
3. Replace rank icon img element:
   - Remove: `<img v-if="rankIconUrl && !rankError" ... @error="handleRankError" />`
   - Add: `<LazyImage v-if="rankIconUrl" :src="rankIconUrl" :alt="\`\${playerRankName} rank icon\`" class="player-header__rank-icon" @error="handleRankError" />`
   - Keep placeholder div as fallback
4. Remove `avatarError` and `rankError` refs (LazyImage handles errors)
5. Remove `handleAvatarError` and `handleRankError` functions
6. Keep placeholder divs for when src is empty

**Part B: Modify src/components/legends/LegendCard.vue**

1. Import LazyImage component
2. Replace legend art img element:
   - Remove: `<img v-if="imageUrl && !imageError" ... @error="handleImageError" />`
   - Add: `<LazyImage v-if="imageUrl" :src="imageUrl" :alt="\`\${legendName} legend art\`" class="legend-card__image" @error="handleImageError" />`
3. Remove `imageError` ref
4. Remove `handleImageError` function
5. Keep placeholder div for when imageUrl is empty

**Verification checklist:**
- All img tags replaced except those in SVG components (platform icons)
- LazyImage imported and registered in both components
- Error handling still works via @error event
- Placeholder divs still show when src is empty
  </action>
  <verify>
1. Run `npm run dev` and navigate to a player profile
2. Open DevTools Network tab with "Disable cache" checked
3. Reload page — observe images load as they enter viewport
4. Scroll to legend cards — images should load before fully visible (50px margin)
5. Test with invalid image URL — should show placeholder
6. Test on slow network (DevTools throttling) — gray placeholders appear, then fade in
  </verify>
  <done>
PlayerHeader.vue uses LazyImage for avatar and rank icon. LegendCard.vue uses LazyImage for legend art. All images fade in with 0.4s cubic-bezier animation. Gray placeholders show during loading. Viewport images load immediately.
</done>
</task>

</tasks>

<verification>
1. **Lazy loading works:** Open DevTools Network tab, reload page — off-screen images don't load until scrolled into view
2. **Viewport images load immediately:** Avatar and rank icon (in viewport) load immediately on page load, no IntersectionObserver delay
3. **Fade-in animation:** Images fade in smoothly over 0.4s with cubic-bezier(0.16, 1, 0.3, 1) easing
4. **Gray placeholder:** Solid color placeholder (#374151 or custom) shows while loading
5. **Error fallback:** Invalid/missing image URLs show placeholder instead of broken image icon
6. **RootMargin works:** Images start loading ~50px before entering viewport
7. **All images converted:** No regular img tags remain in PlayerHeader or LegendCard (except SVG platform icons)
</verification>

<success_criteria>
- [ ] All images (avatars, rank icons, legend art) use LazyImage component
- [ ] Fade-in animation matches existing transitions.css timing
- [ ] Gray placeholder shows during loading
- [ ] Viewport images load immediately without IntersectionObserver delay
- [ ] Failed images show placeholder fallback
- [ ] Images load before entering viewport (50px rootMargin)
- [ ] No layout shift when images load (aspect-ratio preserved)
</success_criteria>

<output>
After completion, create `.planning/phases/04-performance/04-02-SUMMARY.md` with:
- Lazy loading implementation details
- Performance measurements (before/after initial load time)
- Any deviations from plan
- Next steps
</output>
